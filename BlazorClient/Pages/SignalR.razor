@using Microsoft.Extensions.Configuration;
@using Microsoft.AspNetCore.SignalR.Client;
@using BlazorClient.Services;
@using Blazored.LocalStorage;


@inject IConfiguration configuration
@inject UserInfoService _userInfoService
@inject ILocalStorageService localStorage

@implements IAsyncDisposable


<CascadingValue Value=_hubConnection>
    @ChildContent
</CascadingValue>


@code {

    [Parameter]
    public RenderFragment ChildContent { get; set; }

    HubConnection _hubConnection;
    int amount = 0;

    protected override async Task OnInitializedAsync()
    {
        await base.OnInitializedAsync();



        var gid = Guid.NewGuid().ToString();
        await localStorage.SetItemAsync("gid", gid);


        Console.WriteLine("singnalR amount" + amount++);
        Console.WriteLine("singnalR ststus" + _hubConnection?.State);
        //_hubConnection = new HubConnectionBuilder().WithUrl("https://94.251.148.92:5013/chatHub", (opts) =>
        //{
        //_hubConnection = new HubConnectionBuilder().WithUrl("https://192.168.8.222:91/chatHub", (opts) =>
        //{
        _hubConnection = new HubConnectionBuilder().WithUrl(configuration.GetSection("AppSettings")["SignlRAddress"], (opts) =>
        {
            opts.HttpMessageHandlerFactory = (message) =>
            {
                if (message is HttpClientHandler clientHandler)
                    // bypass SSL certificate
                    clientHandler.ServerCertificateCustomValidationCallback +=
                                              (sender, certificate, chain, sslPolicyErrors) => { return true; };
                return message;
            };
        }).WithAutomaticReconnect().Build();

        await _hubConnection.StartAsync();

        _userInfoService.SetUserInfo(gid, (a) => a.ClientSignalRID = _hubConnection.ConnectionId);

        _hubConnection.Reconnected += (connectionId) =>
        {
            _userInfoService.SetUserInfo(gid, (a) => a.ClientSignalRID = connectionId);
            return Task.CompletedTask;
        };

    }

    public async ValueTask DisposeAsync()
    {
        await _hubConnection?.DisposeAsync();
    }

}
